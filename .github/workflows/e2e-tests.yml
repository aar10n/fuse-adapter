name: E2E Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  e2e-tests:
    runs-on: ubuntu-latest
    # Note: MinIO is started manually in a step below because GitHub Actions
    # services don't support custom commands for the MinIO image

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Install FUSE dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y fuse3 libfuse3-dev pkg-config

      - name: Enable FUSE for user
        run: |
          sudo modprobe fuse
          sudo chmod 666 /dev/fuse
          # Enable user_allow_other for FUSE mounts
          echo "user_allow_other" | sudo tee -a /etc/fuse.conf
          sudo chmod 644 /etc/fuse.conf

      - name: Start MinIO
        run: |
          docker run -d --name minio \
            -p 9000:9000 \
            -e MINIO_ROOT_USER=minioadmin \
            -e MINIO_ROOT_PASSWORD=minioadmin \
            minio/minio server /data

          # Wait for MinIO to be ready
          for i in {1..30}; do
            if curl -s http://localhost:9000/minio/health/live > /dev/null 2>&1; then
              echo "MinIO is ready"
              break
            fi
            echo "Waiting for MinIO... ($i/30)"
            sleep 1
          done

      - name: Build fuse-adapter
        run: cargo build --release

      - name: Install cargo-nextest
        uses: taiki-e/install-action@nextest

      - name: Build e2e test crate
        run: cargo build -p fuse-adapter-e2e

      - name: Verify fuse-adapter can mount
        run: |
          # Create a test bucket
          pip3 install awscli
          export AWS_ACCESS_KEY_ID=minioadmin
          export AWS_SECRET_ACCESS_KEY=minioadmin
          aws --endpoint-url http://localhost:9000 s3 mb s3://test-verify-mount || true

          # Create a minimal config
          mkdir -p /tmp/verify-mount
          cat > /tmp/verify-config.yaml << EOF
          logging:
            level: debug
          mounts:
            - path: /tmp/verify-mount
              connector:
                type: s3
                bucket: test-verify-mount
                region: us-east-1
                endpoint: http://localhost:9000
                force_path_style: true
          EOF

          # Try to start fuse-adapter and capture any errors
          echo "Starting fuse-adapter..."
          timeout 10 ./target/release/fuse-adapter /tmp/verify-config.yaml &
          ADAPTER_PID=$!
          sleep 3

          # Check if mount succeeded
          echo "Checking mount..."
          mount | grep verify-mount || echo "Mount not found in mount list"
          ls -la /tmp/verify-mount || echo "Could not list mount directory"

          # Check if process is still running
          if kill -0 $ADAPTER_PID 2>/dev/null; then
            echo "fuse-adapter is running (PID: $ADAPTER_PID)"
            # Try to unmount
            fusermount -u /tmp/verify-mount || fusermount3 -u /tmp/verify-mount || true
            kill $ADAPTER_PID || true
          else
            echo "fuse-adapter exited unexpectedly"
            wait $ADAPTER_PID || echo "Exit code: $?"
          fi

      - name: Run E2E tests
        run: cargo nextest run -p fuse-adapter-e2e --profile ci -j 2
        env:
          MINIO_ENDPOINT: http://localhost:9000
          MINIO_ACCESS_KEY: minioadmin
          MINIO_SECRET_KEY: minioadmin
          CACHE_TYPE: filesystem_fast
          RUST_LOG: debug

      - name: Stop MinIO
        if: always()
        run: docker stop minio || true

  # Separate job for benchmarks (only on main branch push)
  benchmarks:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-bench-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-bench-

      - name: Install FUSE dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y fuse3 libfuse3-dev pkg-config

      - name: Enable FUSE for user
        run: |
          sudo modprobe fuse
          sudo chmod 666 /dev/fuse
          # Enable user_allow_other for FUSE mounts
          echo "user_allow_other" | sudo tee -a /etc/fuse.conf
          sudo chmod 644 /etc/fuse.conf

      - name: Start MinIO
        run: |
          docker run -d --name minio \
            -p 9000:9000 \
            -e MINIO_ROOT_USER=minioadmin \
            -e MINIO_ROOT_PASSWORD=minioadmin \
            minio/minio server /data

          for i in {1..30}; do
            if curl -s http://localhost:9000/minio/health/live > /dev/null 2>&1; then
              echo "MinIO is ready"
              break
            fi
            sleep 1
          done

      - name: Build fuse-adapter
        run: cargo build --release

      - name: Setup benchmark mount
        run: |
          # Create a test bucket and mount for benchmarks
          pip3 install awscli
          export AWS_ACCESS_KEY_ID=minioadmin
          export AWS_SECRET_ACCESS_KEY=minioadmin
          aws --endpoint-url http://localhost:9000 s3 mb s3://benchmark-bucket

          # Create mount directory
          mkdir -p /tmp/fuse-bench

          # Start fuse-adapter in background (would need proper config)
          # For now, just note that benchmarks need manual setup

      - name: Run benchmarks
        run: |
          # Note: Benchmarks require a mounted FUSE filesystem
          # This is a placeholder - full benchmark CI requires more setup
          echo "Benchmark CI setup needed - see tests/e2e/benches/ for local usage"
          # cargo bench -p fuse-adapter-e2e -- --save-baseline ci

      - name: Stop MinIO
        if: always()
        run: docker stop minio || true
