name: CI

on:
  push:
    branches: ["*"]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    services:
      minio:
        image: minio/minio:latest
        ports:
          - 9000:9000
        env:
          MINIO_ROOT_USER: minioadmin
          MINIO_ROOT_PASSWORD: minioadmin
        options: >-
          --health-cmd "curl -f http://localhost:9000/minio/health/live || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
          --entrypoint ""
        # minio server needs to be started manually with entrypoint override
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libfuse3-dev fuse3 pkg-config

      - name: Enable FUSE for user
        run: |
          sudo modprobe fuse
          sudo chmod 666 /dev/fuse
          echo "user_allow_other" | sudo tee -a /etc/fuse.conf

      - name: Start MinIO
        run: |
          docker run -d --name minio \
            -p 9000:9000 \
            -e MINIO_ROOT_USER=minioadmin \
            -e MINIO_ROOT_PASSWORD=minioadmin \
            minio/minio:latest server /data

      - name: Wait for MinIO
        run: |
          for i in {1..30}; do
            if curl -sf http://localhost:9000/minio/health/live; then
              echo "MinIO is ready"
              exit 0
            fi
            sleep 1
          done
          echo "MinIO failed to start"
          exit 1

      - name: Setup MinIO client
        run: |
          docker exec minio mc alias set local http://localhost:9000 minioadmin minioadmin

      - name: Build
        run: cargo build

      - name: Run unit tests
        run: cargo test

      - name: Run integration tests
        run: ./scripts/test-harness.sh --ci
        env:
          MINIO_ENDPOINT: http://localhost:9000
          MINIO_ACCESS_KEY: minioadmin
          MINIO_SECRET_KEY: minioadmin

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libfuse3-dev pkg-config

      - name: Check formatting
        run: cargo fmt --check

      - name: Clippy
        run: cargo clippy -- -D warnings
