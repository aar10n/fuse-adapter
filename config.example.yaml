# fuse-adapter configuration example
#
# This file demonstrates how to configure fuse-adapter with various
# connectors and cache layers.

# Logging configuration
logging:
  # Log level: trace, debug, info, warn, error
  level: info

# Error handling mode for connector failures during startup
# - continue: Log errors but continue with remaining successful mounts (default)
# - exit: Exit with error code on first connector failure
error_mode: continue

# =============================================================================
# Connector Defaults (Optional)
# =============================================================================
# Define default settings for each connector type. Mounts can inherit these
# defaults and only specify overrides (like prefix for different subpaths).

connectors:
  s3:
    bucket: my-shared-bucket
    region: us-east-1
    # Optional: custom endpoint for S3-compatible stores (MinIO, LocalStack)
    # endpoint: "http://localhost:9000"
    # Optional: force path-style URLs (required for some S3-compatible stores)
    # force_path_style: true
    # Optional: default cache for all S3 mounts
    cache:
      type: filesystem
      path: /var/cache/fuse-adapter/s3
      max_size: "1GB"
      flush_interval: 30s
      # Optional: glob patterns for files to exclude from syncing to backend
      # These files will exist locally but never be uploaded
      # exclude_from_sync:
      #   - "*.tmp"
      #   - "__pycache__/**"

# =============================================================================
# Mount Points
# =============================================================================
# Each mount can either:
# 1. Use connector defaults (just specify type + any overrides)
# 2. Provide full connector config (for different buckets, etc.)
#
# Mount-level options:
# - path: Mount point directory (required)
# - read_only: Mount as read-only (default: false)
# - uid: User ID reported for all files (default: process uid)
# - gid: Group ID reported for all files (default: process gid)
# - error_mode: "continue" or "exit" (overrides global setting)
# - status_overlay: Virtual status directory configuration
# - connector: Storage backend configuration (required)
# - cache: Cache layer configuration (inherits from connector defaults)

mounts:
  # --- Using Connector Defaults ---
  # These mounts inherit bucket, region, endpoint, etc. from connectors.s3
  # and only specify the subpath prefix. They also inherit the default cache.

  - path: /mnt/s3-exports
    connector:
      type: s3
      prefix: "data/exports/"

  - path: /mnt/s3-imports
    connector:
      type: s3
      prefix: "data/imports/"
    # Override the default cache for this mount with in-memory write-back cache
    cache:
      type: memory
      max_entries: 1000
      max_size: "100MB"
      flush_interval: 30s

  # --- Full Config (Ignoring Defaults) ---
  # When you specify 'bucket', the mount uses full config mode and
  # ignores connector defaults entirely.

  - path: /mnt/s3-other-bucket
    connector:
      type: s3
      bucket: other-bucket
      region: eu-west-1
    cache:
      type: filesystem
      path: /var/cache/fuse-adapter/other-bucket

  # --- Minimal Config ---
  # S3 mount without caching (not recommended for write operations)
  - path: /mnt/s3-direct
    connector:
      type: s3
      bucket: temp-storage
      region: us-east-1
    cache:
      type: none

  # --- Exclude from Sync Example ---
  # This example shows how to use exclude_from_sync to keep certain files
  # local-only while syncing the rest to the backend. Useful for:
  # - Python virtual environments (sync packages, not binaries)
  # - Build artifacts that should stay local
  # - Temporary files that don't need to be persisted
  #
  # - path: /mnt/s3-venv
  #   connector:
  #     type: s3
  #     bucket: my-bucket
  #     prefix: "projects/myapp/"
  #   cache:
  #     type: filesystem
  #     path: /var/cache/fuse-adapter/venv
  #     max_size: "2GB"
  #     flush_interval: 30s
  #     exclude_from_sync:
  #       # Exclude venv binaries and tools (platform-specific, recreatable)
  #       - ".venv/bin/*"
  #       - ".venv/include/*"
  #       # Exclude pip itself (comes with Python)
  #       - ".venv/lib/python*/site-packages/pip/*"
  #       - ".venv/lib/python*/site-packages/pip-*.dist-info/*"
  #       # Exclude compiled Python files (recreatable)
  #       - "**/__pycache__/**"
  #       - "**/*.pyc"

  # --- Google Drive connector ---
  # Mounts a Google Drive folder as a local filesystem.
  # Supports three authentication methods: service_account, http, and token.
  # root_folder_id is optional and defaults to "root" (My Drive).
  #
  # Service Account Auth:
  # Create a service account in Google Cloud Console, enable Drive API,
  # download the credentials JSON, and share the target folder with the
  # service account email.
  #
  # - path: /mnt/gdrive
  #   connector:
  #     type: gdrive
  #     # root_folder_id: "1ABC123..."  # optional, defaults to "root"
  #     auth:
  #       type: service_account
  #       credentials_path: /etc/fuse-adapter/gdrive-service-account.json
  #   cache:
  #     type: filesystem
  #     path: /var/cache/fuse-adapter/gdrive
  #
  # HTTP Token Provider Auth:
  # Fetches OAuth tokens from an external endpoint. Supports environment
  # variable substitution with ${VAR_NAME} syntax in header values.
  # Endpoint should return JSON: { "access_token": "...", "expires_in": 3600 }
  #
  # - path: /mnt/gdrive
  #   connector:
  #     type: gdrive
  #     auth:
  #       type: http
  #       endpoint: "https://auth.example.com/oauth/token"
  #       method: GET                        # optional, defaults to GET
  #       headers:
  #         Authorization: "Bearer ${AUTH_TOKEN}"
  #         X-User-Id: "user@example.com"
  #
  # Static Token Auth (for testing):
  # Uses a pre-obtained OAuth access token directly.
  #
  # - path: /mnt/gdrive
  #   connector:
  #     type: gdrive
  #     auth:
  #       type: token
  #       access_token: "ya29.your_access_token_here"

  # --- Kubernetes Sidecar Example ---
  # When running fuse-adapter as a sidecar container in Kubernetes, you may need
  # to configure uid/gid so that the main container's user can access the mount.
  #
  # For example, if your main container runs as user 'sandbox' with uid 1000,
  # configure the mount to report files as owned by that user:
  #
  # - path: /mnt/shared-data
  #   uid: 1000
  #   gid: 1000
  #   connector:
  #     type: s3
  #     bucket: my-bucket
  #     prefix: "sandbox-data/"
  #   cache:
  #     type: filesystem
  #     path: /var/cache/fuse-adapter/shared
